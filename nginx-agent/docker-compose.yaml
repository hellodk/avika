version: "3.9"

volumes:
  geodb:

services:

  # ============================
  # GEOIP DATABASE UPDATER
  # ============================
  geodb-updater:
    image: ghcr.io/maxmind/geoipupdate:latest
    container_name: geodb-updater
    environment:
      GEOIPUPDATE_ACCOUNT_ID: "000000"
      GEOIPUPDATE_LICENSE_KEY: "dummy"
      GEOIPUPDATE_EDITION_IDS: "GeoLite2-City GeoLite2-Country"
      GEOIPUPDATE_FREQUENCY: "24"
    volumes:
      - geodb:/usr/share/GeoIP
    restart: unless-stopped

  # ============================
  # BACKEND
  # ============================
  backend:
    image: hashicorp/http-echo
    command: ["-listen=:8080", "-text=OK"]
    environment:
      TZ: Asia/Kolkata
    ports:
      - "8180:8080"

  # ============================
  # NGINX x4
  # ============================

  nginx1:
    image: docker.io/hellodk/avika-agent:latest
    depends_on: [backend, geodb-updater]
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - geodb:/usr/share/GeoIP:ro
    ports:
      - "9081:80"
    extra_hosts:
      - "host.docker.internal:host-gateway"

  nginx2:
    image: docker.io/hellodk/avika-agent:latest
    depends_on: [backend, geodb-updater]
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - geodb:/usr/share/GeoIP:ro
    ports:
      - "9082:80"
    extra_hosts:
      - "host.docker.internal:host-gateway"

  nginx3:
    image: docker.io/hellodk/avika-agent:latest
    depends_on: [backend, geodb-updater]
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - geodb:/usr/share/GeoIP:ro
    ports:
      - "9083:80"
    extra_hosts:
      - "host.docker.internal:host-gateway"

  nginx4:
    image: docker.io/hellodk/avika-agent:latest
    depends_on: [backend, geodb-updater]
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - geodb:/usr/share/GeoIP:ro
    ports:
      - "9084:80"
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # ============================
  # LOCAL LOAD
  # ============================

  traffic-generator:
    image: curlimages/curl:latest
    depends_on: [nginx1]
    command: >
      sh -c '
      while true; do
        for i in 1 2 3 4 5; do
          curl -s http://nginx1/ > /dev/null;
          curl -s -X POST http://nginx1/ -d "load=$RANDOM" > /dev/null;
          curl -s -X PUT http://nginx1/ -d "update=$RANDOM" > /dev/null;
        done;
        sleep 0.2;
      done
      '

  # ============================
  # GLOBAL TRAFFIC x4
  # ============================

  global-traffic1:
    image: curlimages/curl:latest
    depends_on: [nginx1]
    command: &globalgen |
      sh -c '
      IPS="8.8.8.8 1.1.1.1 52.95.110.1 13.107.21.200
           91.198.174.192 203.0.113.10 185.199.108.153
           34.117.59.81 151.101.1.69 104.16.132.229"

      METHODS="GET POST PUT DELETE PATCH"
      PATHS="/ /api/orders /api/users /login /checkout /health"

      rand() { echo $((RANDOM % $1)); }

      while true; do
        IP=$(echo $IPS | tr " " "\n" | sed -n "$(( $(rand 10) + 1 ))p")
        METHOD=$(echo $METHODS | tr " " "\n" | sed -n "$(( $(rand 5) + 1 ))p")
        PATH=$(echo $PATHS | tr " " "\n" | sed -n "$(( $(rand 6) + 1 ))p")

        if [ "$METHOD" = "GET" ]; then
          curl -s http://nginx$((RANDOM%4+1))$PATH \
            -H "X-Forwarded-For: $IP" > /dev/null
        else
          curl -s -X $METHOD http://nginx$((RANDOM%4+1))$PATH \
            -H "X-Forwarded-For: $IP" \
            -H "Content-Type: application/json" \
            -d "{\"id\":$RANDOM}" > /dev/null
        fi

        sleep 0.05
      done
      '

  global-traffic2:
    image: curlimages/curl:latest
    depends_on: [nginx2]
    command: *globalgen

  global-traffic3:
    image: curlimages/curl:latest
    depends_on: [nginx3]
    command: *globalgen

  global-traffic4:
    image: curlimages/curl:latest
    depends_on: [nginx4]
    command: *globalgen
