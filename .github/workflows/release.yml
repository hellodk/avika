name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.2.3)'
        required: true
        type: string

env:
  GO_VERSION: '1.22'
  NODE_VERSION: '20'

permissions:
  contents: write
  packages: write

jobs:
  # ============================================
  # Build Release Binaries
  # ============================================
  build-binaries:
    name: Build Binaries
    runs-on: ubuntu-latest
    strategy:
      matrix:
        goos: [linux, darwin, windows]
        goarch: [amd64, arm64]
        exclude:
          - goos: windows
            goarch: arm64
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Build Gateway
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 0
        run: |
          cd cmd/gateway
          EXT=""
          if [ "${{ matrix.goos }}" == "windows" ]; then
            EXT=".exe"
          fi
          go build -ldflags="-s -w \
            -X main.Version=${{ steps.version.outputs.VERSION }} \
            -X main.BuildDate=$(date -u +%Y-%m-%dT%H:%M:%SZ) \
            -X main.GitCommit=${{ github.sha }}" \
            -o ../../dist/gateway-${{ matrix.goos }}-${{ matrix.goarch }}${EXT} .

      - name: Build Agent
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 0
        run: |
          cd cmd/agent
          EXT=""
          if [ "${{ matrix.goos }}" == "windows" ]; then
            EXT=".exe"
          fi
          go build -ldflags="-s -w \
            -X main.Version=${{ steps.version.outputs.VERSION }} \
            -X main.BuildDate=$(date -u +%Y-%m-%dT%H:%M:%SZ) \
            -X main.GitCommit=${{ github.sha }}" \
            -o ../../dist/agent-${{ matrix.goos }}-${{ matrix.goarch }}${EXT} .

      - name: Create checksums
        run: |
          cd dist
          sha256sum * > checksums-${{ matrix.goos }}-${{ matrix.goarch }}.txt

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: binaries-${{ matrix.goos }}-${{ matrix.goarch }}
          path: dist/

  # ============================================
  # Build Docker Images
  # ============================================
  build-docker:
    name: Build Docker Images
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Gateway
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./cmd/gateway/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/nginx-gateway:${{ steps.version.outputs.VERSION }}
            ${{ secrets.DOCKERHUB_USERNAME }}/nginx-gateway:latest
            ghcr.io/${{ github.repository_owner }}/nginx-gateway:${{ steps.version.outputs.VERSION }}
            ghcr.io/${{ github.repository_owner }}/nginx-gateway:latest
          build-args: |
            VERSION=${{ steps.version.outputs.VERSION }}
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            GIT_COMMIT=${{ github.sha }}

      - name: Build and push Agent
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./deploy/docker/Dockerfile.agent
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/nginx-agent:${{ steps.version.outputs.VERSION }}
            ${{ secrets.DOCKERHUB_USERNAME }}/nginx-agent:latest
            ghcr.io/${{ github.repository_owner }}/nginx-agent:${{ steps.version.outputs.VERSION }}
            ghcr.io/${{ github.repository_owner }}/nginx-agent:latest

      - name: Build and push Frontend
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/nginx-frontend:${{ steps.version.outputs.VERSION }}
            ${{ secrets.DOCKERHUB_USERNAME }}/nginx-frontend:latest
            ghcr.io/${{ github.repository_owner }}/nginx-frontend:${{ steps.version.outputs.VERSION }}
            ghcr.io/${{ github.repository_owner }}/nginx-frontend:latest

  # ============================================
  # Create GitHub Release
  # ============================================
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-binaries, build-docker]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Organize release files
        run: |
          mkdir -p release
          cp artifacts/binaries-*/* release/ || true

      - name: Generate changelog
        id: changelog
        run: |
          # Get the previous tag
          PREV_TAG=$(git describe --abbrev=0 --tags HEAD^ 2>/dev/null || echo "")
          
          if [ -z "$PREV_TAG" ]; then
            echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
            echo "## Initial Release" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            git log --pretty=format:"- %s" | head -20 >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
            echo "## Changes since $PREV_TAG" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            git log ${PREV_TAG}..HEAD --pretty=format:"- %s" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.VERSION }}
          name: Release ${{ steps.version.outputs.VERSION }}
          body: |
            ## NGINX Manager ${{ steps.version.outputs.VERSION }}

            ${{ steps.changelog.outputs.CHANGELOG }}

            ## Docker Images

            ```bash
            # Docker Hub
            docker pull ${{ secrets.DOCKERHUB_USERNAME }}/nginx-gateway:${{ steps.version.outputs.VERSION }}
            docker pull ${{ secrets.DOCKERHUB_USERNAME }}/nginx-agent:${{ steps.version.outputs.VERSION }}
            docker pull ${{ secrets.DOCKERHUB_USERNAME }}/nginx-frontend:${{ steps.version.outputs.VERSION }}

            # GitHub Container Registry
            docker pull ghcr.io/${{ github.repository_owner }}/nginx-gateway:${{ steps.version.outputs.VERSION }}
            docker pull ghcr.io/${{ github.repository_owner }}/nginx-agent:${{ steps.version.outputs.VERSION }}
            docker pull ghcr.io/${{ github.repository_owner }}/nginx-frontend:${{ steps.version.outputs.VERSION }}
            ```

            ## Installation

            ### Binary Installation
            Download the appropriate binary for your platform from the assets below.

            ### Helm Installation
            ```bash
            helm repo add nginx-manager https://your-helm-repo.example.com
            helm install nginx-manager nginx-manager/nginx-manager --version ${{ steps.version.outputs.VERSION }}
            ```

            ## Checksums
            See checksums files in the release assets for verification.
          files: release/*
          draft: false
          prerelease: ${{ contains(steps.version.outputs.VERSION, '-') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================
  # Publish Helm Chart
  # ============================================
  publish-helm:
    name: Publish Helm Chart
    runs-on: ubuntu-latest
    needs: [create-release]
    steps:
      - uses: actions/checkout@v4

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          # Remove 'v' prefix for Helm version
          echo "VERSION=${VERSION#v}" >> $GITHUB_OUTPUT

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: v3.12.0

      - name: Update Chart version
        run: |
          sed -i "s/^version:.*/version: ${{ steps.version.outputs.VERSION }}/" deploy/helm/nginx-manager/Chart.yaml
          sed -i "s/^appVersion:.*/appVersion: \"${{ steps.version.outputs.VERSION }}\"/" deploy/helm/nginx-manager/Chart.yaml

      - name: Package Helm chart
        run: |
          helm package deploy/helm/nginx-manager -d .cr-release-packages

      - name: Upload Helm chart as artifact
        uses: actions/upload-artifact@v4
        with:
          name: helm-chart
          path: .cr-release-packages/
