apiVersion: v1
kind: ConfigMap
metadata:
  name: avika-agent-config
  namespace: default
data:
  # Gateway address - use Kubernetes service DNS name
  # For external agents, override with actual gateway IP/hostname
  GATEWAY_SERVER: "avika-gateway.avika.svc.cluster.local:5020"
  # Update server URL - use Kubernetes service DNS name
  # For external agents, override with actual gateway HTTP URL
  UPDATE_SERVER: "http://avika-gateway.avika.svc.cluster.local:5021"
  UPDATE_INTERVAL: "168h"
  NGINX_STATUS_URL: "http://127.0.0.1/nginx_status"
  ACCESS_LOG_PATH: "/var/log/nginx/access.log"
  ERROR_LOG_PATH: "/var/log/nginx/error.log"
  LOG_FORMAT: "combined"
  BUFFER_DIR: "/var/lib/avika-agent/"
  LOG_LEVEL: "info"
  HEALTH_PORT: "5026"
  MGMT_PORT: "5025"
  TZ: "Asia/Kolkata"
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx
  namespace: default
  labels:
    app: nginx
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: hellodk/avika-agent:latest
        ports:
        - containerPort: 80
          name: http
        - containerPort: 5025
          name: mgmt
        - containerPort: 5026
          name: health
        envFrom:
        - configMapRef:
            name: avika-agent-config
        env:
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 512Mi
        livenessProbe:
          httpGet:
            path: /healthz
            port: 5026
          initialDelaySeconds: 10
          periodSeconds: 30
        readinessProbe:
          httpGet:
            path: /readyz
            port: 5026
          initialDelaySeconds: 5
          periodSeconds: 10
---
apiVersion: v1
kind: Service
metadata:
  name: nginx
  namespace: default
spec:
  selector:
    app: nginx
  ports:
  - name: http
    port: 80
    targetPort: 80
  - name: mgmt
    port: 5025
    targetPort: 5025
  - name: health
    port: 5026
    targetPort: 5026
  type: ClusterIP
