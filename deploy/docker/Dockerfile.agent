# =============================================================================
# Avika NGINX Manager Agent - Container Image
# =============================================================================
# Multi-stage build for minimal production image
#
# Resource Profile (from profiling 2026-02-15):
#   Memory: 1.4 MB baseline, 4.5 MB peak, <10 MB max
#   CPU: <1% typical, 5% peak during discovery
#   Recommended limits: 64Mi memory, 200m CPU
# =============================================================================

# --- Build Stage ---
FROM golang:1.24-alpine AS builder

ARG VERSION=dev
ARG BUILD_DATE=unknown
ARG GIT_COMMIT=unknown

WORKDIR /app

# Install build dependencies
RUN apk add --no-cache make git

# Copy source code
COPY . .

# Build the agent with version info
# -s -w strips debug info for smaller binary
RUN cd cmd/agent && CGO_ENABLED=0 go build -ldflags="-s -w \
    -X main.Version=${VERSION} \
    -X main.BuildDate=${BUILD_DATE} \
    -X main.GitCommit=${GIT_COMMIT}" \
    -o /app/agent .

# --- Production Stage ---
FROM alpine:3.19

# =============================================================================
# RESOURCE LIMITS DOCUMENTATION
# =============================================================================
# When deploying this container, apply these resource limits:
#
# Kubernetes:
#   resources:
#     requests:
#       memory: "32Mi"
#       cpu: "50m"
#     limits:
#       memory: "64Mi"
#       cpu: "200m"
#
# Docker:
#   docker run --memory=64m --memory-swap=64m --cpus=0.2 avika-agent
#
# Docker Compose:
#   deploy:
#     resources:
#       limits:
#         cpus: '0.20'
#         memory: 64M
#       reservations:
#         cpus: '0.05'
#         memory: 32M
# =============================================================================

WORKDIR /app

# Install minimal runtime dependencies
# - curl: health checks
# - bash: debugging (optional, can remove for smaller image)
RUN apk add --no-cache curl bash ca-certificates && \
    rm -rf /var/cache/apk/*

# Copy binary from builder
COPY --from=builder /app/agent /app/agent

# Create required directories with proper permissions
RUN mkdir -p /var/lib/avika/buffer /var/lib/avika/backups /var/log/avika && \
    chmod 755 /var/lib/avika /var/lib/avika/buffer /var/lib/avika/backups /var/log/avika

# Set Go runtime limits via environment
# GOGC=50: More aggressive GC to keep memory low
# GOMEMLIMIT=56MiB: Soft memory limit (below container limit)
ENV GOGC=50
ENV GOMEMLIMIT=56MiB
ENV GOMAXPROCS=2

# Expose ports (5020-5050 range)
# 5025: Management gRPC service
# 5026: Health check HTTP endpoints
EXPOSE 5025 5026

# Health check - use /healthz endpoint
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl -sf http://localhost:5026/healthz || exit 1

# Run as non-root user (when not managing NGINX directly)
# Note: For NGINX management, may need to run as root or with capabilities
# RUN adduser -D -u 1000 avika
# USER avika

# Default command with conservative settings
# Note: In Kubernetes, these are overridden by environment variables from ConfigMap
CMD ["/app/agent", \
     "-gateway", "avika-gateway:5020", \
     "-buffer-dir", "/var/lib/avika/buffer/", \
     "-health-port", "5026", \
     "-mgmt-port", "5025"]
