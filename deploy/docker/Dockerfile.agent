# --- Build Stage ---
FROM golang:1.24-alpine AS builder

ARG VERSION=dev
ARG BUILD_DATE=unknown
ARG GIT_COMMIT=unknown

WORKDIR /app

# Install build dependencies
RUN apk add --no-cache make git

# Copy source code
COPY . .

# Build the agent with version info
RUN cd cmd/agent && go build -ldflags="-s -w \
    -X main.Version=${VERSION} \
    -X main.BuildDate=${BUILD_DATE} \
    -X main.GitCommit=${GIT_COMMIT}" \
    -o /app/agent .

# --- Production Stage ---
FROM alpine:3.19

WORKDIR /app

# Install runtime dependencies
RUN apk add --no-cache sudo nginx curl bash

# Copy binary from builder
COPY --from=builder /app/agent /app/agent

# Create buffer directory
RUN mkdir -p /var/lib/nginx-manager/buffer

# Expose ports (5020-5050 range)
EXPOSE 5025 5026

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:5026/health || exit 1

# Use shell form for proper variable expansion
# Default variables are set via Helm/K8s env vars
CMD ["/app/agent", "-server", "nginx-manager-gateway:5020", "-buffer-dir", "/var/lib/nginx-manager/buffer/", "-health-port", "5026", "-mgmt-port", "5025"]
