apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-config
  namespace: utilities
data:
  nginx.conf: |
    worker_processes auto;

    events {
      worker_connections 65535;
      multi_accept on;
    }

    http {
      sendfile on;
      tcp_nopush on;
      tcp_nodelay on;
      keepalive_timeout 65;

      # ---------- Request correlation ----------
      map $request_id $req_id {
        default $request_id;
        "" "$remote_addr-$msec";
      }

      # ---------- Structured high-fidelity telemetry ----------
      log_format telemetry escape=json
      '{'
        '"ts":"$time_iso8601",'
        '"req_id":"$req_id",'
        '"client":"$remote_addr",'
        '"xff":"$http_x_forwarded_for",'
        '"method":"$request_method",'
        '"path":"$uri",'
        '"status":$status,'
        '"bytes":$body_bytes_sent,'
        '"rt":$request_time,'
        '"uct":"$upstream_connect_time",'
        '"uht":"$upstream_header_time",'
        '"urt":"$upstream_response_time",'
        '"upstream":"$upstream_addr",'
        '"ustatus":"$upstream_status",'
        '"referer":"$http_referer",'
        '"ua":"$http_user_agent"'
      '}';

      access_log /var/log/nginx/access.log telemetry;
      error_log  /var/log/nginx/error.log warn;

      # ---------- Upstream with visibility ----------
      upstream backend {
        zone backend 256k;
        server backend:8080;
        keepalive 64;
      }

      # ---------- Process-level metrics (stub_status) ----------
      server {
        listen 8080;
        server_name localhost;

        location /nginx_status {
          stub_status;
          allow all;
        }

        location /health {
          return 200 'OK';
          add_header Content-Type text/plain;
        }
      }

      # ---------- Application traffic ----------
      server {
        listen 80 default_server;
        server_name _;

        location / {
          proxy_http_version 1.1;

          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Request-ID $req_id;

          proxy_connect_timeout 5s;
          proxy_send_timeout 60s;
          proxy_read_timeout 60s;

          proxy_next_upstream error timeout http_502 http_503 http_504;
          proxy_next_upstream_tries 3;

          proxy_pass http://backend;
        }
      }
    }

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: backend
  namespace: utilities
spec:
  replicas: 1
  selector:
    matchLabels:
      app: backend
  template:
    metadata:
      labels:
        app: backend
    spec:
      containers:
      - name: backend
        image: hashicorp/http-echo
        args: ["-listen=:8080", "-text=OK"]
        env:
        - name: TZ
          value: Asia/Kolkata
        ports:
        - containerPort: 8080

---
apiVersion: v1
kind: Service
metadata:
  name: backend
  namespace: utilities
spec:
  selector:
    app: backend
  ports:
  - port: 8080

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx
  namespace: utilities
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: docker.io/hellodk/avika-nginx-agent:0.1.86
        env:
        - name: TZ
          value: Asia/Kolkata
        - name: AVIKA_STUB_STATUS_URL
          value: "http://127.0.0.1:8080/nginx_status"
        - name: AVIKA_GATEWAY_ADDR
          value: "avika-gateway.avika.svc.cluster.local:5030"
        ports:
        - containerPort: 80
          name: http
        - containerPort: 8080
          name: status
        - containerPort: 5025
          name: mgmt
        - containerPort: 5026
          name: health
        volumeMounts:
        - name: nginx-config
          mountPath: /etc/nginx/nginx.conf
          subPath: nginx.conf
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 5
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 3
          periodSeconds: 5
      volumes:
      - name: nginx-config
        configMap:
          name: nginx-config

---
apiVersion: v1
kind: Service
metadata:
  name: nginx
  namespace: utilities
spec:
  type: NodePort
  selector:
    app: nginx
  ports:
  - name: http
    port: 80
    targetPort: 80
    nodePort: 32767

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: traffic-generator
  namespace: utilities
spec:
  replicas: 1
  selector:
    matchLabels:
      app: traffic-generator
  template:
    metadata:
      labels:
        app: traffic-generator
    spec:
      containers:
      - name: traffic
        image: curlimages/curl:latest
        env:
        - name: TZ
          value: Asia/Kolkata
        command: ["/bin/sh", "-c"]
        args:
          - |
            while true; do
              for i in 1 2 3 4 5; do
                curl -s http://nginx/ > /dev/null;
                curl -s -X POST http://nginx/ -d "load=$RANDOM" > /dev/null;
                curl -s -X PUT http://nginx/ -d "update=$RANDOM" > /dev/null;
              done;
              sleep 0.2;
            done

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: global-traffic-generator
  namespace: utilities
spec:
  replicas: 1
  selector:
    matchLabels:
      app: global-traffic-generator
  template:
    metadata:
      labels:
        app: global-traffic-generator
    spec:
      containers:
      - name: traffic
        image: alpine:latest
        env:
        - name: TZ
          value: Asia/Kolkata
        command: ["/bin/sh", "-c"]
        args:
          - |
            apk add --no-cache curl
            
            # Global IPs for geo diversity testing
            set -- 8.8.8.8 1.1.1.1 52.95.110.1 13.107.21.200 91.198.174.192 203.0.113.10 185.199.108.153 34.117.59.81 151.101.1.69 104.16.132.229 139.130.4.5 177.54.144.106 41.203.65.114 103.21.244.0 202.12.29.205 196.216.2.1
            IPS="$@"
            NUM_IPS=$#
            
            while true; do
              # Pick random IP
              IDX=$(($(od -An -tu4 -N4 /dev/urandom | tr -d ' ') % NUM_IPS + 1))
              IP=$(echo $IPS | cut -d' ' -f$IDX)
              
              # Pick random method
              case $(($(od -An -tu4 -N4 /dev/urandom | tr -d ' ') % 5)) in
                0) METHOD="GET" ;;
                1) METHOD="POST" ;;
                2) METHOD="PUT" ;;
                3) METHOD="DELETE" ;;
                4) METHOD="PATCH" ;;
              esac
              
              # Pick random path
              case $(($(od -An -tu4 -N4 /dev/urandom | tr -d ' ') % 8)) in
                0) ENDPOINT="/" ;;
                1) ENDPOINT="/api/orders" ;;
                2) ENDPOINT="/api/users" ;;
                3) ENDPOINT="/login" ;;
                4) ENDPOINT="/checkout" ;;
                5) ENDPOINT="/health" ;;
                6) ENDPOINT="/api/products" ;;
                7) ENDPOINT="/api/cart" ;;
              esac
              
              PAYLOAD="{\"id\":$RANDOM,\"amount\":$((RANDOM%5000)),\"user\":\"u$RANDOM\"}"
              
              if [ "$METHOD" = "GET" ]; then
                curl -s http://nginx$ENDPOINT -H "X-Forwarded-For: $IP" > /dev/null 2>&1
              else
                curl -s -X $METHOD http://nginx$ENDPOINT -H "X-Forwarded-For: $IP" -H "Content-Type: application/json" -d "$PAYLOAD" > /dev/null 2>&1
              fi
              
              sleep 0.1
            done
